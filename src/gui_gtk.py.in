#! /usr/bin/env python
# Creative Commons has made the contents of this file
# available under a CC-GNU-LGPL license:
#
# http://creativecommons.org/licenses/LGPL/2.1/
#
# A copy of the full license can be found as part of this
# distribution in the file COPYING.
# 
# You may use the liblicense software in accordance with the
# terms of that license. You agree that you are solely 
# responsible for your use of the liblicense software and you
# represent and warrant to Creative Commons that your use
# of the liblicense software will comply with the CC-GNU-LGPL.
#
# Copyright 2007, Creative Commons, www.creativecommons.org.
# Copyright 2007, Scott Shawcroft.

import gtk
import gobject
import liblicense

try:
	import gettext
	t = gettext.translation('liblicense')
	_ = t.ugettext
except:
	print "Translations unavailable"
	_ = lambda x: x

icon_location = "@LICENSE_ICON_DIR@"
if icon_location[0]=="@":
    icon_location="."

attributes = ["http://creativecommons.org/ns#Attribution",
              "http://creativecommons.org/ns#Distribution",
              "http://creativecommons.org/ns#DerivativeWorks",
              "http://creativecommons.org/ns#CommercialUse",
              "http://creativecommons.org/ns#ShareAlike"] 

class LicenseWidget(gtk.VBox):
    __gsignals__ = {"changed":(gobject.SIGNAL_RUN_FIRST,gobject.TYPE_NONE,(gobject.TYPE_STRING,))}
    def __init__(self,license):
        icon_size=48
        icon_padding = 4
        gtk.VBox.__init__(self)
            
        self.set_spacing(5)
        # Attribution
        box = gtk.HBox()
        box.show()
        
        self.by = gtk.CheckButton()
        self.by.show()
        
        icon = gtk.Image()
        icon.set_from_pixbuf(gtk.gdk.pixbuf_new_from_file_at_size(icon_location + "/by.svg", icon_size, icon_size))
        icon.show()
        box.pack_start(icon,False,False,icon_padding)

        label = gtk.Label(_("Require Attribution"))
        label.show()
        box.pack_start(label,False,False,10)

        self.by.add(box)
        self.pack_start(self.by)
        
        # Allow Sharing
        box = gtk.HBox()
        box.show()
        
        self.ash = gtk.CheckButton()
        self.ash.show()
        
        icon = gtk.Image()
        icon.set_from_pixbuf(gtk.gdk.pixbuf_new_from_file_at_size(icon_location+"/ash.svg", icon_size, icon_size))
        icon.show()
        box.pack_start(icon,False,False,icon_padding)
        
        label = gtk.Label(_("Allow Sharing"))
        label.show()
        box.pack_start(label,False,False,10)

        self.ash.add(box)
        self.pack_start(self.ash)
        
        # Allow Remixing
        box = gtk.HBox()
        box.show()
        
        self.ar = gtk.CheckButton()
        self.ar.show()
        self.ar.connect("toggled",self.ar_toggled)
        
        icon = gtk.Image()
        icon.set_from_pixbuf(gtk.gdk.pixbuf_new_from_file_at_size(icon_location + "/ar.svg", icon_size, icon_size))
        icon.show()
        box.pack_start(icon,False,False,icon_padding)
        
        label = gtk.Label(_("Allow Remixing"))
        label.show()
        box.pack_start(label,False,False,10)

        self.ar.add(box)
        self.pack_start(self.ar)
        
        # Prohibit Commercial Works
        box = gtk.HBox()
        box.show()
        
        self.pcw = gtk.CheckButton()
        self.pcw.show()
        
        icon = gtk.Image()
        icon.set_from_pixbuf(gtk.gdk.pixbuf_new_from_file_at_size(icon_location + "/pcw.svg", icon_size, icon_size))
        icon.show()
        box.pack_start(icon,False,False,icon_padding)
        
        label = gtk.Label(_("Prohibit Commercial Works"))
        label.show()
        box.pack_start(label,False,False,10)

        self.pcw.add(box)
        self.pack_start(self.pcw)
        
        # Require Others to Share-Alike
        box = gtk.HBox()
        box.show()
        
        self.sa = gtk.CheckButton()
        self.sa.show()
        
        icon = gtk.Image()
        icon.set_from_pixbuf(gtk.gdk.pixbuf_new_from_file_at_size(icon_location + "/sa.svg", icon_size, icon_size))
        icon.show()
        box.pack_start(icon,False,False,icon_padding)
        
        label = gtk.Label(_("Require Others to Share-Alike"))
        label.show()
        box.pack_start(label,False,False,10)

        self.sa.add(box)
        self.pack_start(self.sa)
        
        # License and URI
        hbox = gtk.HBox()
        hbox.show()
        
        box = gtk.VBox()
        box.show()
        hbox.pack_start(box,False,False,5)
        
        label = gtk.Label(_("License:"))
        label.show()
        box.pack_start(label)
        
        label = gtk.Label(_("Jurisdiction:"))
        label.show()
        box.pack_start(label)
        
        label = gtk.Label(_("License URI:"))
        label.show()
        box.pack_start(label)
        
        box = gtk.VBox()
        box.show()
        
        #license
        self.license = gtk.Entry()
        self.license.set_editable(False)
        self.license.set_has_frame(False)
        self.license.show()
        box.pack_start(self.license)
        
        #jurisdiction
        self.jurisdictions = gtk.ListStore(str,str,gtk.gdk.Pixbuf)
        self.jurisdiction = gtk.ComboBox(self.jurisdictions)
        cell = gtk.CellRendererPixbuf()
        self.jurisdiction.pack_start(cell, False)
        self.jurisdiction.add_attribute(cell, 'pixbuf', 2)
        cell = gtk.CellRendererText()
        self.jurisdiction.pack_start(cell, True)
        self.jurisdiction.add_attribute(cell, 'text', 1)

        self._j = liblicense.get_jurisdictions()
        for juris in self._j:
            self.jurisdictions.append([juris,_(liblicense.jurisdiction_name(juris)),gtk.gdk.pixbuf_new_from_file_at_size(icon_location + "/"+juris+".png",27,16)])
        self._j[0] = None #refer to unported as None

        self.jurisdiction.show()
        
        box.pack_start(self.jurisdiction,False,False,0)
        
        self.uri = gtk.Entry()
        self.uri.set_editable(True)
        self.uri.show()
        box.pack_start(self.uri)
        self.label = label
        self.icon = icon
        hbox.pack_start(box)
        self.pack_start(hbox)
        
        self.set_license(license)
        
        # hook up license switcher
        self.by.connect("toggled",self.checkbox_toggled,0)
        self.ash.connect("toggled",self.checkbox_toggled,1)
        self.ar.connect("toggled",self.checkbox_toggled,2)
        self.pcw.connect("toggled",self.checkbox_toggled,3)
        self.sa.connect("toggled",self.checkbox_toggled,4)
        
        self.jurisdiction.connect("changed",self.update_jurisdiction)

    def do_size_request(self, requisition):
        gtk.VBox.do_size_request(self,requisition)
        #give extra space for the long-ish URI's and license names
        requisition.width = requisition.width + 125

    def update_checkboxes(self,license):
        if license:
            self.current_flags= list(self.license_flags(license))
        else:
            self.current_flags=[False,False,False,False,False]
        self.by.set_active(self.current_flags[0])
        self.ash.set_active(self.current_flags[1])
        self.ar.set_active(self.current_flags[2])
        self.ar.toggled()
        self.pcw.set_active(self.current_flags[3])
        self.sa.set_active(self.current_flags[4])
        

    def ar_toggled(self,button):
        self.sa.set_sensitive(button.get_active())
        if not button.get_active():
            self.sa.set_active(False)
            self.sa.toggled()
    
    def checkbox_toggled(self,button,flag):
        self.current_flags[flag] = button.get_active()
        self.update_license()
    
    def update_license(self):
        licenses = self.ll_chooser.get_licenses(
          permits=(self.current_flags[1]<<1)|(self.current_flags[2]<<2),
          requires=(self.current_flags[0]<<0)|(self.current_flags[4]<<4),
          prohibits=(self.current_flags[3]<<3))

        if licenses:
            u = licenses[0]
            self.emit("changed",u)
            self.uri.set_text(u)
            v = liblicense.get_version(u)
            if v:
              version = " - "+".".join(map(str,v))
            else:
              version = ""
            self.license.set_text("%s%s" % (liblicense.get_name(u), version))
        else:
            self.uri.set_text("")
            self.license.set_text(_("None"))

    def update_chooser(self, license=None):
        j = self.jurisdictions[self.jurisdiction.get_active()][0]
        self.ll_chooser = liblicense.LicenseChooser(j,attributes)
    
    def license_flags(self,license):
        permits = liblicense.get_permits(license)
        requires = liblicense.get_requires(license)
        prohibits = liblicense.get_prohibits(license)
        return (attributes[0] in requires,
                attributes[1] in permits,
                attributes[2] in permits,
                attributes[3] in prohibits,
                attributes[4] in requires)
    
    def update_jurisdiction(self, widget):
        self.update_chooser()
        self.update_license()
    
    def set_license(self, license):
        if license and liblicense.verify_uri(license):
            v = liblicense.get_version(license)
            if v:
              version = " - "+".".join(map(str,v))
            else:
              version = ""
            self.license.set_text("%s%s" % (liblicense.get_name(license), version))
            self.uri.set_text(license)
            
            self.jurisdiction.set_active(self._j.index(liblicense.get_jurisdiction(license)))
        else:
            self.license.set_text(_("None"))
            self.jurisdiction.set_active(0)
            license=None
        self.update_chooser()
        self.update_checkboxes(license)
    
    def get_license(self):
        return self.uri.get_text()

if __name__=="__main__":
    import sys
    if len(sys.argv)<2:
        print "Please pass a test filename in."
        sys.exit(1)
    def close(window):
        sys.exit(0)
    def changed(widget,uri):
        print "changed: " + uri
    window = gtk.Window()
    window.connect("destroy",close)
    window.set_title("liblicense widget test")
    widget = LicenseWidget(liblicense.read(sys.argv[1]))
    widget.connect("changed",changed)
    widget.show()
    window.add(widget)
    window.show()
    gtk.main()
